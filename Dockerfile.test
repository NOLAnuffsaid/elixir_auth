FROM elixir:1.10

RUN apt-get update -y \
    && apt-get install -y postgresql postgresql-contrib

USER postgres


ARG DB_USER
ARG DB_PW

ENV DB_USER $DB_USER
ENV DB_PW $DB_PW

RUN pg_ctlcluster 11 main start \
    && sleep 8 \
    && psql -U postgres -c "CREATE USER $DB_USER WITH CREATEDB LOGIN ENCRYPTED PASSWORD '$DB_PW'"


RUN useradd -D -g "" wjmill

USER wjmill

COPY . /home/wjmill/app

WORKDIR /home/wjmill/app

ENTRYPOINT sh mix test
