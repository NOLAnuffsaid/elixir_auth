FROM elixir:1.10

ARG DB_USER
ARG DB_PW

RUN apt-get update -y \
    && apt-get install -y postgresql postgresql-contrib \
    && sleep 3 \
    && pg_ctlcluster 11 main start \
    && sleep 8 \
    && su - postgres \
    && psql -U postgres -c "CREATE USER $DB_USER WITH CREATEDB LOGIN ENCRYPTED PASSWORD '$DB_PW'"


RUN adduser wjmill

USER wjmill

COPY . /home/wjmill/app

WORKDIR /home/wjmill/app

ENTRYPOINT sh mix test
